<html ng-app="demo">
<head>
	<title>Life Letters User Service</title>
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
	<style>
		.form-control { margin-bottom: 5px; }
		pre { font-size: 8pt; }
	</style>
</head>
<body ng-controller="main">
	

	<div class="container">
		<div class="row">
			<div class="col-sm-4">
				<h3>Login</h3>
				<form novalidate ng-submit="login()">
					<input type="text" class="form-control" ng-model="credentials.email" placeholder="email">						
					<input type="password" class="form-control" ng-model="credentials.password" placeholder="password">		<button type="submit" class="form-control btn btn-primary">Login</button>
				</form>
				<hr>
				<a ng-click="logout()">Log out</a><br>
				<hr>
				<div ng-repeat="type in userTypes">
					is {{ type }}: {{ isType(type) | json }}
				</div>
			</div><!-- .col-sm-6 -->
			<div class="col-sm-4">
				<h3>User</h3>
				<pre>{{ user | json }}</pre>
			</div><!-- .col-sm-4 -->
			<div class="col-sm-4">
				<h3>Orders</h3>
				<pre>{{ orders | json }}</pre>
			</div><!-- .col-sm-8 -->
		</div><!-- .row -->
	</div><!-- .container -->

	<script src="bower_components/angular/angular.js"></script>
	<script src="bower_components/ng-lodash/build/ng-lodash.js"></script>
	<script src="bower_components/angular-cookies/angular-cookies.js"></script>
	<script src="angular-users.js"></script>

	<script>
		angular.module('demo', ['life.users'])
			.config(function(userServiceProvider) {
				userServiceProvider.setUrl('http://localhost:3000/api/v1/');
				userServiceProvider.addBehaviour('fetchOrders',
					function(user) { 
						return user.fetch('orders');
					});
			})
			.controller('main', function($scope, users) {

				$scope.userTypes = users.userTypes;
				$scope.user = users.getLoggedInUser();
				$scope.orders = [];

				$scope.$watch('user', function() {
					if ( $scope.user ) {
						$scope.user.fetchOrders()
							.then(function(orders) { 
								$scope.orders = orders; 
							});
					}
				})

				$scope.credentials = {};
				$scope.login = function() {
					users.logIn($scope.credentials.email, $scope.credentials.password)
						.then(function(user) {
							$scope.user = user;
						});
				};
				$scope.logout = function() {
					users.logOut();
				};
				$scope.isType = function(type) {
					return users.getLoggedInUser() && users.getLoggedInUser()['is'+type]();
				};
			});
	</script>
</body>
</html>